<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>üéõÔ∏è MEZCLADOR INTELIGENTE</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <style>
        body { background-color: #050505; color: #e0e0e0; font-family: system-ui, sans-serif; margin: 0; padding: 20px; }
        h1 { color: #00d2ff; margin: 0; font-size: 1.5rem; }
        
        .panel { background: #111; border: 1px solid #333; padding: 15px; border-radius: 8px; margin-top: 15px; }
        .highlight { border-color: #00d2ff; box-shadow: 0 0 10px rgba(0, 210, 255, 0.1); }
        
        input[type=range] { width: 100%; accent-color: #00d2ff; cursor: pointer; height: 30px; }
        
        /* MONITOR AUTOMATICO */
        .monitor-box { 
            padding: 15px; border-radius: 6px; margin-top: 10px; font-weight: bold; text-align: center; transition: 0.3s; 
            border: 1px solid #333;
        }
        .monitor-on { background: #00ff41; color: #000; box-shadow: 0 0 15px #00ff41; }
        .monitor-off { background: #333; color: #666; }

        .channel { display: flex; align-items: center; justify-content: space-between; background: #1a1a1a; padding: 10px; margin-bottom: 5px; border-left: 3px solid #00d2ff; border-radius: 4px; margin-top: 10px; }
        
        #overlay { position: fixed; inset: 0; background: #000; z-index: 99; display: flex; justify-content: center; align-items: center; }
        #btn-start { padding: 20px 40px; font-size: 1.5rem; background: #00d2ff; border: none; border-radius: 50px; font-weight: bold; }
    </style>
</head>
<body>

    <div id="overlay"><button id="btn-start">INICIAR MEZCLADOR ‚ö°</button></div>

    <h1>üéõÔ∏è BASE CENTRAL</h1>
    <div style="color: #666; font-size: 0.8rem;">ID: obr-mezclador-central</div>

    <div class="panel">
        <strong>üéß ESTADO DEL MONITOR (LOCAL)</strong>
        <div id="monitor-status" class="monitor-box monitor-off">ESPERANDO ORDEN...</div>
        <p style="font-size: 0.7rem; color: #888; text-align: center;">
            Si DETECTOR est√° en ROJO = Escuchas aqu√≠.<br>
            Si DETECTOR est√° en VERDE = Se silencia aqu√≠.
        </p>
    </div>

    <div class="panel highlight">
        <label>VOLUMEN DE ENV√çO A DETECTOR</label>
        <input type="range" id="master-vol" min="0" max="3" step="0.1" value="1.5">
    </div>

    <div id="channels">
        <div class="channel" style="border-left-color: #fff;">
            <span>üéôÔ∏è MI MICR√ìFONO (LOCAL)</span>
        </div>
    </div>

<script>
    const MY_ID = "obr-mezclador-central";
    let audioCtx, broadcastNode, monitorNode, masterGain;
    let peer;

    document.getElementById('btn-start').addEventListener('click', async () => {
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        audioCtx = new AudioContext();

        // 1. RUTAS DE AUDIO
        masterGain = audioCtx.createGain(); // Hacia Internet
        masterGain.gain.value = 1.5;

        broadcastNode = audioCtx.createMediaStreamDestination(); 
        
        monitorNode = audioCtx.createGain(); // Hacia Bocinas PC
        monitorNode.gain.value = 1; // Empieza encendido (RX OFF)
        updateMonitorUI(true);
        
        monitorNode.connect(audioCtx.destination);
        masterGain.connect(broadcastNode);

        // 2. PEERJS
        peer = new Peer(MY_ID);
        
        peer.on('open', () => console.log("Mezclador Listo"));
        
        // A) AUDIO ENTRANTE (Micr√≥fonos)
        peer.on('call', call => {
            call.answer();
            call.on('stream', stream => addMicrophone(call.peer, stream));
        });

        // B) DATOS ENTRANTES (Comandos del Detector)
        peer.on('connection', conn => {
            // Enviar audio apenas se conecte el detector
            setTimeout(() => {
                peer.call(conn.peer, broadcastNode.stream);
            }, 1000);

            // Escuchar √≥rdenes "RX_ON" o "RX_OFF"
            conn.on('data', data => {
                console.log("Comando recibido:", data);
                if(data.cmd === 'RX_ON') {
                    // Detector en VERDE -> Yo me callo
                    monitorNode.gain.value = 0;
                    updateMonitorUI(false);
                } 
                else if (data.cmd === 'RX_OFF') {
                    // Detector en ROJO -> Yo escucho
                    monitorNode.gain.value = 1;
                    updateMonitorUI(true);
                }
            });
        });

        // 3. MI MICROFONO
        try {
            const stream = await navigator.mediaDevices.getUserMedia({audio: true});
            addMicrophone("LOCAL", stream);
        } catch(e) { console.log("Sin mic"); }

        document.getElementById('overlay').style.display = 'none';
    });

    function addMicrophone(id, stream) {
        const source = audioCtx.createMediaStreamSource(stream);
        source.connect(masterGain); // Al Detector
        source.connect(monitorNode); // A mis bocinas (controlado por Detector)

        if(id !== "LOCAL") {
            const div = document.createElement('div');
            div.className = 'channel';
            div.innerHTML = `<span>üì± ${id}</span><span style="color:#0f0; font-size:0.8rem;">EN VIVO</span>`;
            document.getElementById('channels').appendChild(div);
        }
    }

    document.getElementById('master-vol').addEventListener('input', e => {
        masterGain.gain.value = e.target.value;
    });

    function updateMonitorUI(isOn) {
        const el = document.getElementById('monitor-status');
        if(isOn) {
            el.className = "monitor-box monitor-on";
            el.innerText = "üîä ESCUCHANDO EN MEZCLADOR";
        } else {
            el.className = "monitor-box monitor-off";
            el.innerText = "üîá SILENCIADO (Detector activo)";
        }
    }
</script>
</body>
</html>
