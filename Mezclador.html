<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>üéõÔ∏è MEZCLADOR EMISOR</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <style>
        body { background-color: #050505; color: #e0e0e0; font-family: system-ui, sans-serif; margin: 0; padding: 20px; }
        h1 { color: #00d2ff; margin: 0; font-size: 1.5rem; }
        
        .panel { background: #111; border: 1px solid #333; padding: 15px; border-radius: 8px; margin-top: 15px; }
        .highlight { border-color: #00d2ff; box-shadow: 0 0 10px rgba(0, 210, 255, 0.1); }
        
        label { font-size: 0.8rem; color: #aaa; display: block; margin-bottom: 5px; }
        input[type=range] { width: 100%; accent-color: #00d2ff; cursor: pointer; height: 30px; }
        
        .btn { width: 100%; padding: 12px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; margin-top: 5px; }
        .btn-monitor { background: #333; color: #fff; border: 1px solid #555; }
        .btn-monitor.active { background: #00ff41; color: #000; border-color: #00ff41; }

        .channel-list { margin-top: 20px; }
        .channel { display: flex; align-items: center; justify-content: space-between; background: #1a1a1a; padding: 10px; margin-bottom: 5px; border-left: 3px solid #00d2ff; border-radius: 4px; }
        
        #overlay { position: fixed; inset: 0; background: #000; z-index: 99; display: flex; justify-content: center; align-items: center; }
        #btn-start { padding: 20px 40px; font-size: 1.5rem; background: #00d2ff; border: none; border-radius: 50px; font-weight: bold; }
        
        .status-dot { width: 10px; height: 10px; background: #333; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .connected { background: #00ff41; box-shadow: 0 0 5px #00ff41; }
    </style>
</head>
<body>

    <div id="overlay"><button id="btn-start">INICIAR SISTEMA ‚ö°</button></div>

    <h1>üéõÔ∏è MEZCLADOR (SOURCE)</h1>
    <div style="color: #666; font-size: 0.8rem;">ID: obr-mezclador-central</div>

    <div class="panel highlight">
        <div style="display:flex; justify-content:space-between;">
            <strong style="color:#00d2ff;">üì° SE√ëAL HACIA DETECTOR</strong>
            <div><span id="conn-dot" class="status-dot"></span><span id="conn-text" style="font-size:0.8rem;">Esperando Detector...</span></div>
        </div>
        <hr style="border-color:#333; margin: 10px 0;">
        
        <label>VOLUMEN DE ENV√çO (GANANCIA)</label>
        <input type="range" id="master-vol" min="0" max="3" step="0.1" value="1.5">
    </div>

    <div class="panel">
        <strong>üéß MONITOR LOCAL (PRUEBAS)</strong>
        <p style="font-size: 0.8rem; color: #888; margin: 5px 0;">Activa esto para probar micros si el Detector est√° en OFF.</p>
        <button id="btn-monitor" class="btn btn-monitor">ESCUCHAR AQU√ç: OFF</button>
    </div>

    <div class="channel-list" id="channels">
        <div class="channel" style="border-left-color: #fff;">
            <span>üéôÔ∏è MI MICR√ìFONO (LOCAL)</span>
            <span style="font-size:0.8rem; color:#0f0;">ACTIVO</span>
        </div>
    </div>

<script>
    const MY_ID = "obr-mezclador-central";
    let audioCtx, broadcastNode, monitorNode, masterGain;
    let peer;

    document.getElementById('btn-start').addEventListener('click', async () => {
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        audioCtx = new AudioContext();

        // 1. RUTAS DE AUDIO
        masterGain = audioCtx.createGain(); // Controla volumen hacia Detector
        masterGain.gain.value = 1.5;

        broadcastNode = audioCtx.createMediaStreamDestination(); // El cable a internet
        monitorNode = audioCtx.createGain(); // El cable a tus bocinas
        monitorNode.gain.value = 0; // Empezar silenciado para no viciar
        monitorNode.connect(audioCtx.destination);

        // Conexi√≥n Maestra
        masterGain.connect(broadcastNode);

        // 2. PEERJS
        peer = new Peer(MY_ID);
        
        peer.on('open', () => console.log("Mezclador Abierto"));
        
        // A) Alguien nos llama (Un Micr√≥fono)
        peer.on('call', call => {
            call.answer();
            call.on('stream', stream => {
                // Si es el Detector pidiendo audio, NO lo mezclamos (loop infinito)
                // Pero aqu√≠ asumimos que el Detector solo recibe.
                addMicrophone(call.peer, stream);
            });
        });

        // B) Detector se conecta para recibir audio
        peer.on('connection', conn => {
            document.getElementById('conn-dot').classList.add('connected');
            document.getElementById('conn-text').innerText = "DETECTOR CONECTADO";
            // Cuando el detector se conecta por datos, le llamamos nosotros con el audio
            setTimeout(() => {
                peer.call(conn.peer, broadcastNode.stream);
                console.log("Enviando audio al detector...");
            }, 1000);
        });

        // 3. ACTIVAR MI MICROFONO
        try {
            const stream = await navigator.mediaDevices.getUserMedia({audio: true});
            addMicrophone("LOCAL", stream);
        } catch(e) { console.log("Sin mic local"); }

        document.getElementById('overlay').style.display = 'none';
    });

    // FUNCION: Mezclar Audio
    function addMicrophone(id, stream) {
        const source = audioCtx.createMediaStreamSource(stream);
        
        // Enviar a la Salida (Detector)
        source.connect(masterGain);
        
        // Enviar al Monitor (Local)
        source.connect(monitorNode);

        if(id !== "LOCAL") {
            const div = document.createElement('div');
            div.className = 'channel';
            div.innerHTML = `<span>üì± ${id}</span><span style="color:#0f0; font-size:0.8rem;">EN VIVO</span>`;
            document.getElementById('channels').appendChild(div);
        }
    }

    // CONTROL: Volumen Salida
    document.getElementById('master-vol').addEventListener('input', e => {
        masterGain.gain.value = e.target.value;
    });

    // CONTROL: Monitor Local
    const btnMon = document.getElementById('btn-monitor');
    let monitorOn = false;
    btnMon.addEventListener('click', () => {
        monitorOn = !monitorOn;
        if(monitorOn) {
            monitorNode.gain.value = 1;
            btnMon.classList.add('active');
            btnMon.innerText = "ESCUCHAR AQU√ç: ON";
        } else {
            monitorNode.gain.value = 0;
            btnMon.classList.remove('active');
            btnMon.innerText = "ESCUCHAR AQU√ç: OFF";
        }
    });
</script>
</body>
</html>
