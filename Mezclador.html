<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>üéõÔ∏è MEZCLADOR OBR | BIG</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#050505">
    
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Orbitron:wght@500;700;900&display=swap" rel="stylesheet">
    
    <style>
        :root { --accent: #00d2ff; --bg-dark: #050505; --panel-bg: rgba(20,20,25,0.95); }
        
        html, body {
            width: 100%; height: 100%; margin: 0; padding: 0;
            background-color: var(--bg-dark); 
            background-image: url('./fondo_pantalla.jpg'); 
            background-position: center; background-size: cover; background-attachment: fixed;
            color: #e0e0e0; font-family: 'Share Tech Mono', monospace; 
            overflow: hidden; overscroll-behavior: none; position: fixed; top: 0; left: 0;
            user-select: none; box-sizing: border-box;
        }
        body { padding: 10px; display: flex; flex-direction: column; }
        body::before { content: ""; position: fixed; inset: 0; background: rgba(0,0,0,0.92); z-index: -1; }

        /* HEADER */
        header { 
            display: flex; align-items: center; justify-content: space-between;
            margin-bottom: 10px; padding: 0 10px; border-bottom: 1px solid var(--accent); 
            background: rgba(0,0,0,0.8); border-radius: 6px; flex-shrink: 0; height: 50px; 
        }
        .logo-header { height: 30px; filter: drop-shadow(0 0 5px var(--accent)); }
        .header-center { display: flex; flex-direction: column; align-items: center; line-height: 1; }
        .header-title { font-family: 'Orbitron'; font-size: 0.8rem; color: var(--accent); font-weight: 900; letter-spacing: 1px; }

        /* ESTADO */
        .status-indicator {
            font-size: 0.6rem; padding: 4px 10px; border-radius: 4px; 
            border: 1px solid #333; background: #000; color: #555; font-weight: bold;
            display: flex; align-items: center; gap: 6px; transition: all 0.3s;
            font-family: 'Orbitron'; white-space: nowrap;
        }
        .status-indicator.connected { border-color: #00ff41; color: #00ff41; background: rgba(0, 50, 0, 0.6); box-shadow: 0 0 8px rgba(0, 255, 65, 0.3); }
        .status-indicator.connected .dot { background: #00ff41; box-shadow: 0 0 5px #00ff41; animation: blinkFast 1s infinite; }
        .status-indicator.disconnected { border-color: #774400; color: #ffae00; background: rgba(40, 20, 0, 0.6); }
        .status-indicator.disconnected .dot { background: #ffae00; animation: blinkSlow 2s infinite; }

        .dot { width: 6px; height: 6px; border-radius: 50%; display: inline-block; }
        @keyframes blinkFast { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
        @keyframes blinkSlow { 0%, 100% { opacity: 0.3; } 50% { opacity: 1; } }

        .btn-link {
            background: #222; border: 1px solid #fff; color: #fff; 
            padding: 4px 12px; cursor: pointer; border-radius: 4px; font-family: 'Orbitron';
            font-size: 0.7rem; transition: 0.2s;
        }

        /* CONSOLA (ALINEADA ARRIBA) */
        #console-container { 
            display: flex; gap: 5px; overflow-x: auto; overflow-y: hidden; flex-grow: 1; 
            padding: 5px 0; 
            /* ALINEACION SUPERIOR */
            align-items: flex-start; 
            scrollbar-width: none;
        }
        #console-container::-webkit-scrollbar { display: none; }
        
        /* CHANNEL STRIP (90px ANCHO - DOBLE TAMA√ëO) */
        .channel-strip { 
            background: var(--panel-bg); border: 1px solid #333; border-radius: 6px; padding: 8px 4px; 
            display: flex; flex-direction: column; align-items: center; 
            width: 90px; min-width: 90px; flex-shrink: 0; 
            height: auto; 
            position: relative; gap: 5px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.6);
        }

        .strip-title { 
            font-size: 0.6rem; font-weight: bold; color: #aaa; 
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis; width: 100%; text-align: center;
            border-bottom: 1px solid #333; padding-bottom: 4px;
        }
        
        .vol-display {
            width: 100%; text-align: center; background: transparent; border: none;
            color: var(--accent); font-family: 'Orbitron'; font-size: 0.8rem; font-weight: bold;
            margin: 0; padding: 0; pointer-events: auto; letter-spacing: -0.5px;
        }
        .vol-display:focus { outline: none; color: #fff; background: #222; }

        /* AREA FADER (ALTURA 100PX - DOBLE) */
        .fader-group { 
            display: flex; flex-direction: row; gap: 4px; width: 100%; 
            justify-content: center; align-items: stretch;
            padding: 4px; background: rgba(0,0,0,0.4); border-radius: 4px; margin: 4px 0;
            height: 100px; min-height: 100px; /* MAS ALTO PARA CONTROL */
        }
        
        .vu-meter-wrap {
            width: 8px; height: 100%; background: #0a0a0a; border: 0px solid #444;
            border-radius: 2px; position: relative; overflow: hidden;
        }
        .vu-bg {
            position: absolute; inset: 0; opacity: 0.15;
            background: linear-gradient(to top, #00ff00 0%, #00ff00 60%, #ffff00 60%, #ffff00 85%, #ff0000 85%, #ff0000 100%);
        }
        .vu-active {
            position: absolute; bottom: 0; left: 0; width: 100%; 
            background: linear-gradient(to top, #00ff00 0%, #00ff00 60%, #ffff00 60%, #ffff00 85%, #ff0000 85%, #ff0000 100%);
            height: 0%; transition: height 0.05s linear;
        }

        input[type=range][orient=vertical] { 
            writing-mode: bt-lr; -webkit-appearance: slider-vertical; 
            width: 40px; height: 100%; margin: 0; cursor: ns-resize; accent-color: var(--accent); 
            touch-action: none; 
        }
        
        .btn-mute { width: 100%; padding: 6px 0; background: #333; border: 1px solid #555; color: #888; font-size: 0.6rem; border-radius: 3px; font-weight: bold; text-align: center; letter-spacing: 1px; }
        .btn-mute.muted { background: #500; border-color: #f00; color: #fff; }
        .btn-del { position: absolute; top: -6px; right: -6px; width: 18px; height: 18px; background: #900; color: white; border-radius: 50%; font-size: 0.6rem; display: flex; justify-content: center; align-items: center; z-index: 10; border: 1px solid red; cursor: pointer; }

        .master-mic { border: 1px solid #ffae00; order: 1; }
        .master-mic .strip-title { color: #ffae00; }
        /* Master Out un poco mas grande */
        .master-out { border: 1px solid var(--accent); order: 1000; margin-left: auto; min-width: 95px; width: 95px; }
        .master-out .strip-title { color: var(--accent); }
        
        #routing-display { font-size: 0.5rem; text-align: center; padding: 2px; width: 100%; font-weight: bold; border-radius: 2px; }
        .route-local { color: #888; border: 1px solid #333; }
        .route-remote { color: #000; background: #00ff41; border: 1px solid #00ff41; }

        #overlay { position: fixed; inset: 0; background: #000; z-index: 999; display: flex; flex-direction: column; justify-content: center; align-items: center; background-image: url('./fondo_pantalla.jpg'); background-size: cover; }
        .overlay-content { background: rgba(0,0,0,0.95); padding: 25px; border-radius: 15px; border: 1px solid var(--accent); text-align: center; width: 85%; max-width: 350px; }
        #btn-start { margin-top: 20px; padding: 12px 0; width: 100%; font-size: 1rem; background: transparent; color: var(--accent); border: 1px solid var(--accent); border-radius: 50px; font-family: 'Orbitron'; cursor: pointer; }
        
        #qr-modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 2000; justify-content: center; align-items: center; flex-direction: column; opacity: 0; transition: opacity 0.3s; }
        #qr-modal.active { opacity: 1; }
        #qrcode { background: white; padding: 15px; border-radius: 10px; margin-bottom: 20px; transform: scale(0.8); transition: transform 0.3s; }
        #qr-modal.active #qrcode { transform: scale(1); }
        
        #alert-popup { position: fixed; top: 70px; left: 50%; transform: translateX(-50%); background: rgba(200, 0, 0, 0.95); color: white; padding: 8px 20px; border-radius: 30px; font-family: 'Orbitron'; font-size: 0.7rem; box-shadow: 0 0 20px red; z-index: 5000; display: none; text-align: center; border: 1px solid white; }
    </style>
</head>
<body>

    <div id="alert-popup">‚ö†Ô∏è CONEXI√ìN PERDIDA</div>

    <div id="overlay">
        <div class="overlay-content">
            <img src="./obr-logo.png" style="width: 100px; margin: 0 auto 15px auto; filter: drop-shadow(0 0 10px #00d2ff);" onerror="this.style.display='none'">
            <h1 style="font-family: 'Orbitron'; color:white; font-size: 1.1rem;">MEZCLADOR DE AUDIO</h1>
            <div style="color:#888; font-size:0.7rem; letter-spacing:2px;">EXPLORACIONES OBR</div>
            <button id="btn-start">INICIAR SISTEMA</button>
        </div>
    </div>

    <div id="qr-modal" onclick="closeQR()">
        <h2 style="color:var(--accent); font-family:'Orbitron'; font-size:1rem; margin-bottom:10px;">VINCULAR DISPOSITIVO</h2>
        <div id="qrcode"></div>
        <p style="color:#aaa; font-family:monospace; font-size:0.7rem;">ID: obr-mezclador-central</p>
        <p style="color:#666; font-size:0.6rem; margin-top:20px;">TOCA PARA CERRAR</p>
    </div>

    <header>
        <img src="./obr-logo.png" class="logo-header" onerror="this.style.display='none'">
        <div class="header-center">
            <div class="header-title">EXPLORACIONES OBR</div>
        </div>
        <div id="connection-status" class="status-indicator disconnected">
            <div class="dot"></div> <span id="status-text">ESPERANDO</span>
        </div>
        <button class="btn-link" onclick="showQR()">üì≤ ID</button>
    </header>

    <div id="console-container">
        
        <!-- 1. MICROFONO MASTER -->
        <div class="channel-strip master-mic" id="mic-master">
            <div class="strip-title">üé§ MASTER</div>
            <input type="number" class="vol-display" id="val-mic" value="100" onchange="syncVol('mic', this.value)">
            
            <div class="fader-group">
                <input type="range" orient="vertical" id="fader-mic" min="0" max="300" value="100" oninput="syncVol('mic', this.value, true)">
                <!-- VU METER -->
                <div class="vu-meter-wrap">
                    <div class="vu-bg"></div>
                    <div class="vu-active" id="meter-mic"></div>
                </div>
            </div>
            <button class="btn-mute" id="mute-mic" onclick="toggleMute('mic')">MUTE</button>
        </div>

        <!-- 2. SALIDA MASTER -->
        <div class="channel-strip master-out">
            <div class="strip-title">üîä SALIDA</div>
            <div id="routing-display" class="route-local">LOCAL</div>
            
            <div class="fader-group">
                <input type="range" orient="vertical" id="fader-out" min="0" max="200" value="100" oninput="syncVol('out', this.value, true)">
                <div class="vu-meter-wrap">
                    <div class="vu-bg"></div>
                    <div class="vu-active" id="meter-out"></div>
                </div>
            </div>
            <button class="btn-mute" id="mute-out" onclick="toggleMute('out')">MUTE</button>
        </div>

    </div>
    
    <audio id="silence-hack" loop src="data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAAABkYXRhAgAAAAEA"></audio>
    <div id="remote-audios" style="display:none;"></div>

<script>
    const FIXED_ID = "obr-mezclador-central";
    let peer, audioCtx;
    let masterOutNode, monitorNode, broadcastNode, masterAnalyser, localMicNode;
    let isDetectorConnected = false;
    let savedPeers = JSON.parse(localStorage.getItem('obr_peers') || "[]");
    let micMuted = false, outMuted = false;
    let micLastVol = 100, outLastVol = 100;
    let wakeLock = null;

    document.getElementById('btn-start').addEventListener('click', async () => {
        const elem = document.documentElement;
        if (elem.requestFullscreen) elem.requestFullscreen().catch(e=>{});
        requestWakeLock();

        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        await audioCtx.resume();
        
        // 1. MASTER OUT
        masterOutNode = audioCtx.createGain();
        masterAnalyser = audioCtx.createAnalyser(); 
        masterAnalyser.fftSize = 256; 
        masterOutNode.connect(masterAnalyser);

        // 2. MONITOR (Local)
        monitorNode = audioCtx.createGain();
        masterOutNode.connect(monitorNode);
        monitorNode.connect(audioCtx.destination);

        // 3. BROADCAST
        broadcastNode = audioCtx.createMediaStreamDestination();
        masterOutNode.connect(broadcastNode);

        animateMeter(masterAnalyser, 'meter-out', true); 

        // 4. MICROFONO LOCAL
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ 
                audio: { echoCancellation: true, noiseSuppression: true, autoGainControl: true } 
            });
            const source = audioCtx.createMediaStreamSource(stream);
            
            localMicNode = audioCtx.createGain(); 
            const localAnal = audioCtx.createAnalyser(); localAnal.fftSize = 256; 
            
            source.connect(localAnal); // Pre-fader meter
            source.connect(localMicNode);
            localMicNode.connect(masterOutNode);
            
            animateMeter(localAnal, 'meter-mic'); 
        } catch(e) {
            document.getElementById('mic-master').style.opacity = "0.5";
        }

        document.getElementById('silence-hack').play();
        document.getElementById('overlay').style.display = 'none';
        
        loadSavedPeers();
        initPeer();
        updateRoutingUI(); 
    });

    async function requestWakeLock() {
        if ('wakeLock' in navigator) {
            try { wakeLock = await navigator.wakeLock.request('screen'); } catch (err) {}
        }
    }
    document.addEventListener('visibilitychange', async () => {
        if (wakeLock !== null && document.visibilityState === 'visible') await requestWakeLock();
    });

    function initPeer() {
        peer = new Peer(FIXED_ID);
        
        peer.on('open', id => {
            const qrDiv = document.getElementById("qrcode");
            qrDiv.innerHTML = ""; 
            new QRCode(qrDiv, { text: id, width: 200, height: 200 });
        });

        peer.on('error', err => { if(err.type === 'unavailable-id') alert("‚ö†Ô∏è ID EN USO."); });

        peer.on('connection', conn => {
            conn.on('open', () => {
                isDetectorConnected = true;
                updateStatusUI();
                updateRoutingUI();
                setTimeout(() => { 
                    if(broadcastNode && broadcastNode.stream) peer.call(conn.peer, broadcastNode.stream); 
                }, 1000);
            });
            
            conn.on('close', () => handleDisconnect());
            conn.on('error', () => handleDisconnect());
        });

        peer.on('call', call => {
            call.answer(broadcastNode.stream);
            call.on('stream', remoteStream => createChannelStrip(call.peer, remoteStream, true));
            call.on('close', () => markChannelOffline(call.peer));
        });
    }

    function handleDisconnect() {
        isDetectorConnected = false;
        updateStatusUI();
        updateRoutingUI();
        const popup = document.getElementById('alert-popup');
        popup.style.display = 'block';
        setTimeout(() => popup.style.display = 'none', 3000);
        if("vibrate" in navigator) navigator.vibrate(500);
    }

    function updateStatusUI() {
        const el = document.getElementById('connection-status');
        const txt = document.getElementById('status-text');
        const icon = el.querySelector('.dot');
        
        if(isDetectorConnected) {
            el.className = "status-indicator connected";
            txt.innerText = "ONLINE";
        } else {
            el.className = "status-indicator disconnected";
            txt.innerText = "ESPERANDO";
        }
    }

    function updateRoutingUI() {
        const ind = document.getElementById('routing-display');
        if(isDetectorConnected) {
            monitorNode.gain.value = 0; 
            ind.innerText = "REMOTO";
            ind.className = "route-remote";
        } else {
            monitorNode.gain.value = 1; 
            ind.innerText = "LOCAL";
            ind.className = "route-local";
        }
    }

    function createChannelStrip(id, stream, isLive) {
        let div = document.getElementById('ch-' + id);
        if(div) {
            if(isLive && stream) {
                div.classList.remove('offline');
                div.style.opacity = "1";
                div.querySelector('.strip-title').innerText = `üì° ${id.substring(0,4).toUpperCase()}`;
                attachAudioToStrip(id, stream, div);
            }
            return;
        }

        div = document.createElement('div');
        div.className = 'channel-strip';
        div.id = 'ch-' + id;
        if(!isLive) { div.style.opacity = "0.5"; div.classList.add('offline'); }
        div.style.order = "50"; 
        
        div.innerHTML = `
            <div class="btn-del" onclick="deletePeer('${id}')">√ó</div>
            <div class="strip-title">${isLive ? 'üì°' : '‚ö†Ô∏è'} ${id.substring(0,4).toUpperCase()}</div>
            <input type="number" class="vol-display" id="val-${id}" value="100">
            <div class="fader-group">
                <input type="range" orient="vertical" min="0" max="300" value="100" class="fader-input" id="slider-${id}">
                <div class="vu-meter-wrap">
                    <div class="vu-bg"></div>
                    <div class="vu-active" id="met-${id}"></div>
                </div>
            </div>
            <button class="btn-mute" id="mute-${id}">MUTE</button>
        `;

        const container = document.getElementById('console-container');
        const masterStrip = document.querySelector('.master-out');
        container.insertBefore(div, masterStrip);

        savePeer(id);
        if(isLive && stream) attachAudioToStrip(id, stream, div);
        setupStripEvents(id, div);
    }

    function attachAudioToStrip(id, stream, div) {
        const audioEl = document.createElement('audio');
        audioEl.srcObject = stream; audioEl.muted = true; audioEl.autoplay = true;
        document.getElementById('remote-audios').appendChild(audioEl);

        const source = audioCtx.createMediaStreamSource(stream);
        const gainNode = audioCtx.createGain();
        const analyserNode = audioCtx.createAnalyser(); analyserNode.fftSize = 256;
        
        // POST-FADER ROUTING
        source.connect(gainNode);
        gainNode.connect(analyserNode);
        gainNode.connect(masterOutNode); 
        
        div.audioNodes = { gain: gainNode };
        animateMeter(analyserNode, `met-${id}`);
    }

    function setupStripEvents(id, div) {
        const numberInput = div.querySelector(`#val-${id}`);
        const sliderInput = div.querySelector(`#slider-${id}`);
        const muteBtn = div.querySelector(`#mute-${id}`);
        let chMuted = false; let chLastVol = 100;

        const updateChGain = (val, fromSlider) => {
            let numVal = parseInt(val); if(isNaN(numVal)) numVal = 0; if(numVal > 300) numVal = 300;
            
            if(!chMuted && div.audioNodes && div.audioNodes.gain) {
                div.audioNodes.gain.gain.value = numVal / 100;
            }
            
            if(fromSlider && numberInput) numberInput.value = numVal; 
            else if(sliderInput) sliderInput.value = numVal;
            
            if(numberInput) numberInput.style.color = numVal > 100 ? "#ffae00" : "#00d2ff";
            chLastVol = numVal;
        };
        
        if(numberInput) numberInput.onchange = (e) => updateChGain(e.target.value, false);
        if(sliderInput) sliderInput.oninput = (e) => updateChGain(e.target.value, true);
        if(muteBtn) muteBtn.onclick = () => {
            chMuted = !chMuted;
            if(chMuted) { 
                if(div.audioNodes) div.audioNodes.gain.gain.value = 0; 
                muteBtn.classList.add('muted'); sliderInput.disabled = true; 
            } else { 
                if(div.audioNodes) div.audioNodes.gain.gain.value = chLastVol / 100; 
                muteBtn.classList.remove('muted'); sliderInput.disabled = false; 
            }
        };
    }

    function syncVol(type, val, fromSlider) {
        let numVal = parseInt(val); if(isNaN(numVal)) numVal = 0; if(numVal > 300) numVal = 300;
        
        let inputEl, sliderEl, gainNode, isMuted;
        
        if(type === 'mic') {
            inputEl = document.getElementById('val-mic'); 
            sliderEl = document.getElementById('fader-mic'); 
            gainNode = localMicNode; isMuted = micMuted; 
            if(!isMuted) micLastVol = numVal;
        } else {
            inputEl = document.getElementById('val-out'); 
            sliderEl = document.getElementById('fader-out'); 
            gainNode = masterOutNode; isMuted = outMuted; 
            if(!isMuted) outLastVol = numVal;
        }
        
        if(inputEl && sliderEl) {
            if(gainNode && !isMuted) gainNode.gain.value = numVal / 100;
            if(fromSlider) inputEl.value = numVal; else sliderEl.value = numVal;
            inputEl.style.color = numVal > 100 ? "#ffae00" : (type==='mic'?"#ffae00":"#00d2ff");
        }
    }

    function toggleMute(type) {
        if(type === 'mic' && localMicNode) {
            micMuted = !micMuted;
            const btn = document.getElementById('mute-mic'); const sli = document.getElementById('fader-mic');
            if(micMuted) { localMicNode.gain.value = 0; btn.classList.add('muted'); sli.disabled = true; } 
            else { localMicNode.gain.value = micLastVol / 100; btn.classList.remove('muted'); sli.disabled = false; }
        }
        if(type === 'out' && masterOutNode) {
            outMuted = !outMuted;
            const btn = document.getElementById('mute-out'); const sli = document.getElementById('fader-out');
            if(outMuted) { masterOutNode.gain.value = 0; btn.classList.add('muted'); sli.disabled = true; } 
            else { masterOutNode.gain.value = outLastVol / 100; btn.classList.remove('muted'); sli.disabled = false; }
        }
    }

    function showQR() {
        document.getElementById('qr-modal').style.display = 'flex';
        setTimeout(() => document.getElementById('qr-modal').classList.add('active'), 10);
    }
    function closeQR() {
        document.getElementById('qr-modal').classList.remove('active');
        setTimeout(() => document.getElementById('qr-modal').style.display = 'none', 300);
    }

    function loadSavedPeers() { savedPeers.forEach(peerId => createChannelStrip(peerId, null, false)); }
    function savePeer(id) { if(!savedPeers.includes(id)) { savedPeers.push(id); localStorage.setItem('obr_peers', JSON.stringify(savedPeers)); } }
    function deletePeer(id) { savedPeers = savedPeers.filter(p => p !== id); localStorage.setItem('obr_peers', JSON.stringify(savedPeers)); const el = document.getElementById('ch-' + id); if(el) el.remove(); }
    function markChannelOffline(id) { const el = document.getElementById('ch-' + id); if(el) { el.style.opacity = "0.5"; el.classList.add('offline'); el.querySelector('.strip-title').innerText = `‚ö†Ô∏è ${id.substring(0,4)}...`; } }

    function animateMeter(analyser, elemId) {
        const timeData = new Uint8Array(256); 
        function loop() {
            const el = document.getElementById(elemId);
            if(!el) return;
            requestAnimationFrame(loop);
            if(analyser) {
                analyser.getByteTimeDomainData(timeData);
                let sum = 0;
                for(let i = 0; i < timeData.length; i++) {
                    let x = (timeData[i] - 128) / 128.0;
                    sum += x * x;
                }
                let rms = Math.sqrt(sum / timeData.length); 
                let val = Math.min(100, rms * 400); 
                el.style.height = val + "%";
            }
        }
        loop();
    }
</script>
</body>
</html>
