<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>üéõÔ∏è MEZCLADOR CENTRAL v2.0</title>
    
    <!-- LIBRER√çA PEERJS OBLIGATORIA -->
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <!-- QR CODE (Opcional para facilitar acceso) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <style>
        :root { --accent: #00d2ff; --meter-bg: rgba(0,0,0,0.8); --bg-dark: #050505; }
        
        body { 
            background-color: var(--bg-dark); 
            /* Puedes poner tu imagen de fondo aqu√≠ si la tienes en la misma carpeta */
            background-image: url('./fondo_pantalla.jpg'); 
            background-position: center; background-size: cover; background-attachment: fixed;
            color: #e0e0e0; font-family: 'Segoe UI', system-ui, sans-serif; 
            margin: 0; padding: 10px; display: flex; flex-direction: column; height: 100vh; box-sizing: border-box;
        }
        body::before { content: ""; position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: -1; }

        header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; padding-bottom: 10px; border-bottom: 2px solid var(--accent); }
        .logo-group { display: flex; align-items: center; gap: 10px; }
        .obr-logo { height: 40px; width: auto; }
        h1 { color: var(--accent); margin: 0; font-size: 1.2rem; letter-spacing: 1px; font-weight: bold; text-shadow: 0 0 10px var(--accent); }

        /* INDICADORES DE ESTADO */
        .status-group { display: flex; gap: 10px; align-items: center; }
        .status-badge { 
            padding: 8px 12px; border-radius: 4px; font-size: 0.75rem; font-weight: bold; 
            border: 1px solid #333; background: #111; color: #666; 
            text-transform: uppercase; transition: all 0.3s;
        }
        
        /* ESTADOS DEL DETECTOR (ENLACE) */
        .det-disconnected { 
            background: #330000; color: #ff4444; border-color: #ff0000; 
            box-shadow: inset 0 0 5px #550000; 
        }
        .det-connected { 
            background: rgba(0, 210, 255, 0.2); color: #00d2ff; border-color: #00d2ff; 
            box-shadow: 0 0 15px rgba(0, 210, 255, 0.4); 
            animation: pulseStatus 2s infinite; 
        }
        @keyframes pulseStatus { 50% { box-shadow: 0 0 25px rgba(0, 210, 255, 0.6); } }

        /* CONSOLA DE AUDIO */
        #console-container { 
            display: flex; gap: 10px; overflow-x: auto; flex-grow: 1; 
            background: rgba(0,0,0,0.5); padding: 15px; border-radius: 8px; 
            border: 1px solid #333; backdrop-filter: blur(10px); 
        }
        
        .channel-strip { 
            background: rgba(30,30,35,0.9); border: 1px solid #444; border-radius: 4px; padding: 10px; 
            display: flex; flex-direction: column; align-items: center; min-width: 100px; flex-shrink: 0;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        .strip-title { font-size: 0.7rem; font-weight: bold; margin-bottom: 10px; color: #fff; }
        
        .fader-area { display: flex; gap: 15px; height: 200px; margin-bottom: 15px; width: 100%; justify-content: center; }
        
        /* VU METER */
        .meter-container { width: 15px; height: 100%; background: #000; border: 1px solid #555; border-radius: 2px; position: relative; overflow: hidden; }
        .meter-gradient { position: absolute; inset: 0; background: linear-gradient(to top, #00ff00 0%, #00ff00 60%, #ffff00 80%, #ff0000 100%); }
        .meter-mask { position: absolute; top: 0; left: 0; width: 100%; background: #000; height: 100%; transition: height 0.05s ease-out; }
        
        /* FADER */
        input[type=range][orient=vertical] { 
            writing-mode: bt-lr; -webkit-appearance: slider-vertical; 
            width: 40px; height: 100%; margin: 0; cursor: grab; 
        }

        /* MASTER */
        .master-strip { border: 2px solid var(--accent); background: rgba(0, 20, 30, 0.9); margin-left: auto; }
        .master-title { color: var(--accent); text-shadow: 0 0 5px var(--accent); }

        /* PANTALLA INICIO */
        #overlay { position: fixed; inset: 0; background: #000; z-index: 99; display: flex; justify-content: center; align-items: center; flex-direction: column; }
        #btn-start { 
            padding: 20px 50px; font-size: 1.5rem; 
            background: transparent; color: var(--accent); 
            border: 2px solid var(--accent); border-radius: 8px; 
            font-weight: bold; cursor: pointer; 
            box-shadow: 0 0 20px var(--accent);
            transition: all 0.3s;
        }
        #btn-start:hover { background: var(--accent); color: #000; }
        
        #id-display { margin-top: 20px; font-family: monospace; color: #666; }
    </style>
</head>
<body>

    <!-- PANTALLA DE INICIO (Gesto de usuario requerido por navegadores) -->
    <div id="overlay">
        <button id="btn-start">INICIAR SERVIDOR</button>
        <div id="id-display">ID Fijo: obr-mezclador-central</div>
    </div>

    <header>
        <div class="logo-group">
            <!-- Asegurate de tener el logo o borra esta linea -->
            <!-- <img src="obr-logo.png" class="obr-logo"> -->
            <h1>MEZCLADOR CENTRAL</h1>
        </div>
        <div class="status-group">
            <div id="det-status" class="status-badge det-disconnected">DETECTOR: OFF</div>
            <div id="clients-count" class="status-badge" style="border-color: #fff; color: #fff;">CLIENTES: 0</div>
        </div>
    </header>

    <div id="console-container">
        <!-- CANAL MASTER (Salida) -->
        <div class="channel-strip master-strip" style="order: 99;">
            <div class="strip-title master-title">MASTER OUT</div>
            <div class="fader-area">
                <div class="meter-container"><div class="meter-gradient"></div><div class="meter-mask" id="mask-master"></div></div>
                <input type="range" orient="vertical" id="master-fader" min="0" max="1.5" step="0.01" value="1">
            </div>
        </div>
    </div>
    
    <!-- Audio dummy para desbloquear el contexto en iOS/Android -->
    <audio id="silence-hack" loop src="data:audio/mp3;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4LjIwLjEwMAAAAAAAAAAAAAAA//oeGQAAAAExBTUUzLjEwMKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq"></audio>

<script>
    // --- CONFIGURACI√ìN ---
    const FIXED_ID = "obr-mezclador-central"; // ID QUE BUSCA EL DETECTOR
    
    let peer;
    let audioCtx;
    let masterGain, masterAnalyser;
    let clientCount = 0;

    // --- INICIO ---
    document.getElementById('btn-start').addEventListener('click', async () => {
        // 1. Iniciar Contexto de Audio
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        await audioCtx.resume();
        
        // 2. Configurar Master
        masterGain = audioCtx.createGain();
        masterAnalyser = audioCtx.createAnalyser(); 
        masterAnalyser.fftSize = 64;
        masterGain.connect(masterAnalyser);
        masterGain.connect(audioCtx.destination);
        
        // Hack para mantener audio activo
        document.getElementById('silence-hack').play();
        animateMeter(masterAnalyser, 'mask-master');

        // 3. Iniciar PeerJS (Servidor)
        initPeer();

        // 4. UI
        document.getElementById('overlay').style.display = 'none';
        document.getElementById('master-fader').addEventListener('input', e => masterGain.gain.value = e.target.value);
    });

    function initPeer() {
        peer = new Peer(FIXED_ID, {
            debug: 2
        });

        peer.on('open', id => {
            console.log("MEZCLADOR ONLINE. ID:", id);
            document.title = "üéõÔ∏è MEZCLADOR [ONLINE]";
        });

        // ERROR: Si el ID ya est√° en uso (otra pesta√±a abierta)
        peer.on('error', err => {
            if(err.type === 'unavailable-id') {
                alert("ERROR: El Mezclador ya est√° abierto en otra pesta√±a/dispositivo.");
            } else {
                console.error("Peer Error:", err);
            }
        });

        // --- CONEXI√ìN DE DATOS (Detector Estado) ---
        peer.on('connection', conn => {
            console.log("Nueva conexi√≥n de datos:", conn.peer);
            
            // Al conectar, actualizamos estado a ONLINE
            conn.on('open', () => {
                updateDetectorStatus(true);
                clientCount++;
                updateClients();
            });

            // Escuchar comandos del Detector
            conn.on('data', data => {
                console.log("Comando recibido:", data);
                // Aqu√≠ puedes manejar RX_ON / RX_OFF si quieres mutear algo en el futuro
                // Por ahora es solo para mantener el enlace vivo
            });

            // Manejar desconexi√≥n
            conn.on('close', () => {
                console.log("Conexi√≥n cerrada:", conn.peer);
                updateDetectorStatus(false);
                clientCount = Math.max(0, clientCount - 1);
                updateClients();
            });
            
            conn.on('error', () => {
                 updateDetectorStatus(false);
            });
        });

        // --- CONEXI√ìN DE LLAMADA (Audio Stream) ---
        peer.on('call', call => {
            console.log("Recibiendo llamada de:", call.peer);
            call.answer(); // Responder autom√°ticamente
            
            call.on('stream', remoteStream => {
                addChannelStrip(call.peer, remoteStream);
            });
            
            call.on('close', () => {
                removeChannelStrip(call.peer);
            });
            
            call.on('error', () => removeChannelStrip(call.peer));
        });
    }

    // --- FUNCIONES UI ---

    function updateDetectorStatus(online) {
        const el = document.getElementById('det-status');
        if (online) {
            el.innerText = "DETECTOR: ONLINE";
            el.className = "status-badge det-connected";
        } else {
            el.innerText = "DETECTOR: OFF";
            el.className = "status-badge det-disconnected";
        }
    }
    
    function updateClients() {
        document.getElementById('clients-count').innerText = `CLIENTES: ${clientCount}`;
    }

    // Crear canal de audio en la consola
    function addChannelStrip(id, stream) {
        if(document.getElementById('strip-' + id)) return;

        // Nodo de Audio
        const source = audioCtx.createMediaStreamSource(stream);
        const gain = audioCtx.createGain();
        const analyser = audioCtx.createAnalyser(); analyser.fftSize = 64;
        
        source.connect(gain);
        gain.connect(analyser);
        gain.connect(masterGain); // Enviar al Master

        // HTML
        const div = document.createElement('div');
        div.className = 'channel-strip';
        div.id = 'strip-' + id;
        
        // Nombre corto
        const shortId = id.substring(0,5).toUpperCase();
        
        div.innerHTML = `
            <div class="strip-title">ID: ${shortId}</div>
            <div class="fader-area">
                <div class="meter-container"><div class="meter-gradient"></div><div class="meter-mask" id="mask-${id}"></div></div>
                <input type="range" orient="vertical" class="ch-fader" min="0" max="1.5" step="0.01" value="1">
            </div>
        `;
        
        // Insertar antes del Master
        const container = document.getElementById('console-container');
        const master = document.getElementById('master-channel');
        container.insertBefore(div, master);

        // Eventos Fader
        const fader = div.querySelector('.ch-fader');
        fader.addEventListener('input', e => { gain.gain.value = e.target.value; });

        // Animar VU Meter
        animateMeter(analyser, `mask-${id}`);
    }

    function removeChannelStrip(id) {
        const el = document.getElementById('strip-' + id);
        if(el) el.remove();
    }

    // Animaci√≥n de medidores (VU)
    const dArray = new Uint8Array(64);
    function animateMeter(analyser, maskId) {
        function loop() {
            const mask = document.getElementById(maskId);
            if(!mask) return; // Detener si el elemento ya no existe
            
            requestAnimationFrame(loop);
            analyser.getByteFrequencyData(dArray);
            
            let sum = 0;
            for(let i=0; i<dArray.length; i++) sum += dArray[i];
            let avg = sum / dArray.length;
            
            // Convertir 0-255 a porcentaje de altura invertido (Mask tapa lo de arriba)
            // Si avg es alto (255), height debe ser 0 (mostrar todo)
            // Si avg es bajo (0), height debe ser 100% (tapar todo)
            let h = 100 - (avg / 128 * 100); 
            mask.style.height = Math.max(0, Math.min(100, h)) + "%";
        }
        loop();
    }
</script>
</body>
</html>
