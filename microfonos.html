<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>üéôÔ∏è MICRO OBR (ANTI-ERROR)</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <style>
        :root { --accent: #00d2ff; --danger: #ff0000; --success: #00ff41; }
        body { 
            background-image: url('./fondo_pantalla.jpg');
            background-position: center; background-size: cover; background-color: #000;
            color: #ffffff; font-family: system-ui, -apple-system, sans-serif;
            display: flex; flex-direction: column; align-items: center; min-height: 100vh; margin: 0; padding: 15px; box-sizing: border-box;
        }
        body::before { content: ""; position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: -1; }

        .logo-header { margin-bottom: 15px; text-align: center; }
        .obr-logo { width: 60px; height: auto; margin-bottom: 5px; filter: drop-shadow(0 0 10px var(--accent)); display: block; margin: 0 auto; }
        h1 { margin: 0; color: var(--accent); font-size: 1.2rem; letter-spacing: 2px; }

        .test-panel { background: #1a1a1a; border: 1px solid #444; border-radius: 12px; padding: 15px; width: 100%; max-width: 400px; margin-bottom: 20px; text-align: center; }
        .vu-container { width: 100%; height: 15px; background: #333; border-radius: 5px; overflow: hidden; border: 1px solid #555; margin: 10px 0; position: relative; }
        .vu-bar { width: 0%; height: 100%; background: linear-gradient(90deg, var(--accent), var(--success), var(--danger)); transition: width 0.05s ease-out; }
        
        .btn-refresh { background: #333; color: #fff; border: 1px solid #666; padding: 8px 15px; border-radius: 20px; font-size: 0.8rem; cursor: pointer; margin-bottom: 5px; }
        .btn-monitor { background: #220022; color: #ff88ff; border: 1px solid #ff88ff; padding: 8px 15px; border-radius: 20px; font-size: 0.8rem; cursor: pointer; margin-left: 5px; }
        .btn-monitor.active { background: #ff88ff; color: #000; }

        #qr-reader { width: 100%; border-radius: 8px; overflow: hidden; display: none; background: #000; margin-bottom: 15px; }
        .btn-main { width: 100%; padding: 18px; font-size: 1.1rem; font-weight: bold; border: none; border-radius: 50px; cursor: pointer; transition: all 0.3s; background: var(--accent); color: #000; box-shadow: 0 0 20px rgba(0, 210, 255, 0.2); display: flex; align-items: center; justify-content: center; gap: 10px; }
        .btn-main.live { background: var(--danger); color: white; box-shadow: 0 0 30px rgba(255, 0, 0, 0.6); animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }

        #status { margin-top: 15px; font-size: 0.8rem; color: #666; font-family: monospace; text-align: center; word-break: break-word;}
        #manual-area { display: none; width: 100%; max-width: 400px; display: flex; gap: 5px; margin-top: 10px; }
        .input-code { flex: 1; padding: 10px; background: #222; border: 1px solid #555; color: #fff; border-radius: 5px; text-align: center; }
        .btn-go { width: 50px; background: #333; color: #fff; border: 1px solid #fff; border-radius: 5px; }
        audio { display: none; }
    </style>
</head>
<body>

    <div class="logo-header">
        <img src="./obr-logo.png" alt="OBR Logo" class="obr-logo" onerror="this.style.display='none'">
        <h1>MICROFONO OBR</h1>
    </div>

    <div class="test-panel">
        <div style="font-size:0.7rem; color:#888; margin-bottom:5px;">NIVEL DE AUDIO (RAW)</div>
        <div class="vu-container"><div id="vu-bar" class="vu-bar"></div></div>
        <div style="display:flex; justify-content:center; gap:10px;">
            <button class="btn-refresh" onclick="initAudioSystem()">üîÑ RECARGAR</button>
            <button id="btn-mon" class="btn-monitor" onclick="toggleMonitor()">üéß MONITOR</button>
        </div>
        <p style="font-size:0.65rem; color:#aaa; margin-top:5px;">Si conectas un micro, dale a Recargar.</p>
    </div>

    <div id="qr-reader"></div>

    <div style="width: 100%; max-width: 400px;">
        <button id="btn-action" class="btn-main">
            <span>üì°</span> <span id="btn-text">ESCANEAR ENLACE</span>
        </button>
        <div id="manual-area" style="display:none;">
            <input type="text" id="manual-id" class="input-code" placeholder="ID MANUAL">
            <button class="btn-go" onclick="manualConnect()">IR</button>
        </div>
    </div>

    <div id="status">Sistema listo.</div>
    <audio id="fake-audio" loop playsinline src="data:audio/mp3;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4LjIwLjEwMAAAAAAAAAAAAAAA//oeGQAAAAExBTUUzLjEwMKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq"></audio>

<script>
    // CONFIGURACI√ìN DE RED ROBUSTA (STUN GLOBAL)
    const peerConfig = {
        debug: 2,
        config: {
            iceServers: [
                { urls: 'stun:stun1.l.google.com:19302' },
                { urls: 'stun:stun2.l.google.com:19302' },
                { urls: 'stun:global.stun.twilio.com:3478' }
            ],
            sdpSemantics: 'unified-plan' // CRITICO PARA IPHONE
        }
    };

    const btn = document.getElementById('btn-action');
    const btnText = document.getElementById('btn-text');
    const status = document.getElementById('status');
    const vuBar = document.getElementById('vu-bar');
    const qrContainer = document.getElementById('qr-reader');
    
    let peer, activeStream, audioContext, analyser, microphone, jsNode, monitorNode;
    let currentCall, html5QrCode;
    let isScanning = false, isConnected = false, isMonitoring = false;
    let retryCount = 0; // Contador de reintentos

    // --- INICIO PEER ---
    const myId = "obr-mic-" + Math.floor(Math.random()*10000);
    peer = new Peer(myId, peerConfig);
    
    peer.on('open', id => console.log("ID Local:", id));
    peer.on('error', err => { status.innerText = "Error Sistema: " + err.type; });

    // INICIAR AUDIO RAW AUTOMATICAMENTE
    initAudioSystem();

    async function initAudioSystem() {
        if(activeStream) activeStream.getTracks().forEach(t => t.stop());
        if(audioContext) audioContext.close();

        try {
            // PEDIR AUDIO SIN PROCESAMIENTO (Para que entre el externo)
            const constraints = {
                audio: {
                    echoCancellation: false, noiseSuppression: false, autoGainControl: false,
                    googEchoCancellation: false, googAutoGainControl: false, googNoiseSuppression: false, googHighpassFilter: false
                }
            };
            activeStream = await navigator.mediaDevices.getUserMedia(constraints);
            startVisualizer(activeStream);
            status.innerText = "Microfono Activo (Modo RAW).";
        } catch (e) {
            status.innerText = "Error Micro: " + e.message;
            alert("Permiso de micr√≥fono denegado o error de hardware.");
        }
    }

    function startVisualizer(stream) {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        analyser = audioContext.createAnalyser();
        microphone = audioContext.createMediaStreamSource(stream);
        jsNode = audioContext.createScriptProcessor(2048, 1, 1);
        
        monitorNode = audioContext.createGain(); monitorNode.gain.value = 0;

        analyser.smoothingTimeConstant = 0.3; analyser.fftSize = 1024;

        microphone.connect(analyser);
        microphone.connect(monitorNode); monitorNode.connect(audioContext.destination);
        analyser.connect(jsNode); jsNode.connect(audioContext.destination);

        jsNode.onaudioprocess = () => {
            const array = new Uint8Array(analyser.frequencyBinCount);
            analyser.getByteFrequencyData(array);
            let values = 0; for (let i = 0; i < array.length; i++) values += array[i];
            const average = values / array.length;
            vuBar.style.width = Math.min(100, average * 3) + "%";
        };
    }

    function toggleMonitor() {
        isMonitoring = !isMonitoring;
        const btnMon = document.getElementById('btn-mon');
        if(isMonitoring) { monitorNode.gain.value = 1; btnMon.classList.add('active'); alert("üîä MONITOR ON: Usa aud√≠fonos."); } 
        else { monitorNode.gain.value = 0; btnMon.classList.remove('active'); }
    }

    // --- CONEXI√ìN ---
    btn.addEventListener('click', () => {
        if(isConnected) disconnect();
        else if(isScanning) stopScanner();
        else startScanner();
    });

    function startScanner() {
        isScanning = true; qrContainer.style.display = 'block'; btnText.innerText = "CANCELAR";
        html5QrCode = new Html5Qrcode("qr-reader");
        html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, 
            (decodedText) => { stopScanner(); connectToMixer(decodedText); },
            (err) => {}
        ).catch(err => {
            alert("C√°mara no disponible. Usa ID manual.");
            stopScanner(); document.getElementById('manual-area').style.display = 'flex';
        });
    }

    function stopScanner() {
        isScanning = false;
        if(html5QrCode) html5QrCode.stop().then(() => { qrContainer.style.display = 'none'; html5QrCode.clear(); }).catch(e=>{ qrContainer.style.display = 'none'; });
        btnText.innerText = "ESCANEAR ENLACE";
    }

    function manualConnect() {
        const id = document.getElementById('manual-id').value.trim();
        if(id) connectToMixer(id);
    }

    // === CORAZ√ìN DE LA CONEXI√ìN CON REINTENTOS ===
    function connectToMixer(mixerId) {
        status.innerText = `Intentando conectar (Intento ${retryCount + 1})...`;
        status.style.color = "yellow";

        // Asegurar audio en background
        document.getElementById('fake-audio').play().catch(e=>{});
        if ('wakeLock' in navigator) navigator.wakeLock.request('screen').catch(e=>{});

        if(!activeStream) { alert("Sin audio. Recarga la p√°gina."); return; }
        
        // Cerrar llamada previa si existe
        if(currentCall) currentCall.close();

        try {
            // Crear llamada
            currentCall = peer.call(mixerId, activeStream);
            
            // Esperar error inmediato
            currentCall.on('error', (err) => {
                console.error("Error llamada:", err);
                handleConnectionError(mixerId);
            });

            // PeerJS a veces no lanza 'error' sino que cierra inmediatamente si falla la negociaci√≥n
            currentCall.on('close', () => {
                if(isConnected) disconnect(); // Cierre normal
                else handleConnectionError(mixerId); // Cierre prematuro (fallo)
            });

            // Asumimos √©xito temporalmente para cambiar UI
            setConnectedState(true);
            
            // Verificaci√≥n de seguridad: Si en 5 segundos no hay confirmaci√≥n (opcional), podr√≠amos reintentar
            // Pero por ahora confiamos en el evento 'error' o 'close'

        } catch(e) {
            handleConnectionError(mixerId);
        }
    }

    function handleConnectionError(mixerId) {
        setConnectedState(false);
        
        if(retryCount < 3) {
            retryCount++;
            status.innerText = `Negociaci√≥n fallida. Reintentando (${retryCount}/3)...`;
            status.style.color = "orange";
            
            // Esperar 1.5 segundos y reintentar
            setTimeout(() => {
                connectToMixer(mixerId);
            }, 1500);
        } else {
            retryCount = 0;
            status.innerText = "‚ùå ERROR FATAL: Red incompatible.";
            status.style.color = "red";
            alert("No se pudo establecer conexi√≥n. Posibles causas:\n1. Bloqueo de Firewall/Datos m√≥viles.\n2. El Mezclador se cerr√≥.\n\nIntenta recargar ambas p√°ginas.");
        }
    }

    function setConnectedState(connected) {
        isConnected = connected;
        if(connected) {
            btn.classList.add('live');
            btn.innerHTML = "üõë DETENER";
            status.innerText = "üî¥ EN AIRE - CONECTADO";
            status.style.color = "#ff0000";
            document.getElementById('manual-area').style.display = 'none';
        } else {
            btn.classList.remove('live');
            btn.innerHTML = "<span>üì°</span> <span id='btn-text'>ESCANEAR ENLACE</span>";
            if(retryCount === 0) {
                status.innerText = "Listo para conectar";
                status.style.color = "#aaa";
            }
        }
    }

    function disconnect() {
        retryCount = 0;
        if(currentCall) currentCall.close();
        setConnectedState(false);
    }
</script>
</body>
</html>
