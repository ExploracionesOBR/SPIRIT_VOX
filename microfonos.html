<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>üéôÔ∏è EXPLORACIONES OBR - MICRO</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <style>
        :root { --accent: #00d2ff; --danger: #ff0000; }
        body { 
            /* FONDO DE PANTALLA */
            background: url('fondo_pantalla.jpg') no-repeat center center fixed; 
            background-size: cover; color: #ffffff; font-family: system-ui, -apple-system, sans-serif;
            display: flex; flex-direction: column; align-items: center; min-height: 100vh; margin: 0; padding: 20px; box-sizing: border-box;
            backdrop-filter: brightness(0.3); /* Fondo muy oscuro para resaltar controles */
        }

        .logo-header { margin-bottom: 30px; text-align: center; }
        .obr-logo { width: 80px; height: auto; margin-bottom: 10px; filter: drop-shadow(0 0 10px var(--accent)); }
        h1 { margin: 0; color: var(--accent); font-size: 1.5rem; letter-spacing: 2px; }
        p { color: #aaa; margin-top: 5px; }

        /* CONTENEDOR PRINCIPAL */
        .main-card {
            background: rgba(0,0,0,0.7); border: 1px solid #333; border-radius: 15px;
            padding: 25px; width: 100%; max-width: 400px; text-align: center;
            backdrop-filter: blur(10px); box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        /* √ÅREA DE ESC√ÅNER QR */
        #qr-reader { width: 100%; margin-bottom: 20px; border: none !important; display: none; }
        /* Personalizaci√≥n de la librer√≠a de QR */
        #qr-reader__scan_region { background: rgba(0,0,0,0.5); }
        #qr-reader__dashboard_section_csr button { background: var(--accent) !important; color: black !important; border: none !important; padding: 10px; border-radius: 5px; font-weight: bold; }

        /* BOT√ìN PRINCIPAL (Esc√°ner y Estado) */
        #btn-action {
            width: 100%; padding: 20px; font-size: 1.2rem; font-weight: bold;
            border: none; border-radius: 12px; cursor: pointer; transition: all 0.3s;
            display: flex; align-items: center; justify-content: center; gap: 10px;
            background: var(--accent); color: #000; box-shadow: 0 0 15px rgba(0, 210, 255, 0.3);
        }

        /* Estado: Conectado/Transmitiendo */
        #btn-action.live {
            background: var(--danger); color: white;
            box-shadow: 0 0 30px rgba(255, 0, 0, 0.5);
            animation: pulseLive 1.5s infinite;
        }
        @keyframes pulseLive { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }

        #status { margin-top: 20px; font-weight: bold; color: #666; }
        
        /* Audio invisible para mantener activo el m√≥vil */
        audio { display: none; }
    </style>
</head>
<body>

    <div class="logo-header">
        <img src="obr-logo.png" alt="OBR Logo" class="obr-logo">
        <h1>MICROFONO OBR</h1>
        <p>Unidad de Exploraci√≥n</p>
    </div>

    <div class="main-card">
        <div id="qr-reader"></div>

        <button id="btn-action">
            <span>üì∑</span> <span id="btn-text">ESCANEAR QR MEZCLADOR</span>
        </button>
        
        <div id="status">Listo para enlazar</div>
    </div>

    <audio id="fake-audio" loop playsinline src="data:audio/mp3;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4LjIwLjEwMAAAAAAAAAAAAAAA//oeGQAAAAExBTUUzLjEwMKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq"></audio>

<script>
    const btn = document.getElementById('btn-action');
    const btnText = document.getElementById('btn-text');
    const status = document.getElementById('status');
    const qrContainer = document.getElementById('qr-reader');
    const fakeAudio = document.getElementById('fake-audio');
    
    let peer = null;
    let currentCall = null;
    let html5QrCode = null;
    let isScanning = false;
    let isConnected = false;

    // Generar ID √∫nico para este micr√≥fono
    const myMicId = "obr-mic-" + Math.floor(Math.random() * 9999);
    peer = new Peer(myMicId);

    peer.on('error', err => {
        status.innerText = "Error: " + err.type; colorStatus(false);
    });

    btn.addEventListener('click', () => {
        // Si ya est√° conectado, el bot√≥n sirve para DESCONECTAR
        if(isConnected) {
            stopTransmission();
            return;
        }

        // Si no est√° conectado, el bot√≥n sirve para INICIAR ESC√ÅNER
        if (!isScanning) {
            startQRScanner();
        } else {
            stopQRScanner(); // Cancelar escaneo si se vuelve a tocar
        }
    });

    // --- L√ìGICA DEL ESC√ÅNER QR ---
    function startQRScanner() {
        isScanning = true;
        qrContainer.style.display = "block";
        btnText.innerText = "CANCELAR C√ÅMARA";
        status.innerText = "Apunta al c√≥digo QR del Mezclador...";

        html5QrCode = new Html5Qrcode("qr-reader");
        const config = { fps: 10, qrbox: { width: 250, height: 250 } };
        
        // Usar c√°mara trasera si es posible
        html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess, onScanFailure);
    }

    function stopQRScanner() {
        isScanning = false;
        if(html5QrCode) {
            html5QrCode.stop().then(() => {
                qrContainer.style.display = "none";
                html5QrCode.clear();
            }).catch(err => console.log("Error al parar camara", err));
        }
        if(!isConnected) {
            btnText.innerText = "ESCANEAR QR MEZCLADOR";
            status.innerText = "Escaneo cancelado.";
        }
    }

    // ¬°C√ìDIGO ENCONTRADO!
    function onScanSuccess(decodedText, decodedResult) {
        // decodedText es el ID del mezclador
        console.log(`Code matched = ${decodedText}`);
        stopQRScanner();
        
        // Iniciar proceso de conexi√≥n con el ID escaneado
        connectToMixer(decodedText);
    }
    function onScanFailure(error) { 
        // console.warn(`Code scan error = ${error}`); // Demasiado ruido en consola
    }

    // --- L√ìGICA DE CONEXI√ìN Y AUDIO ---
    async function connectToMixer(mixerId) {
        status.innerText = "Conectando al ID: " + mixerId + "...";
        
        try {
            // 1. Obtener Audio
            const stream = await navigator.mediaDevices.getUserMedia({ 
                audio: { echoCancellation: true, noiseSuppression: true, autoGainControl: true }, video: false 
            });

            // 2. Activar Hacks de segundo plano
            fakeAudio.play().catch(e => {});
            if ('wakeLock' in navigator) navigator.wakeLock.request('screen').catch(e=>{});

            // 3. Llamar al mezclador
            const call = peer.call(mixerId, stream);
            currentCall = call;

            // 4. Actualizar Interfaz a modo "EN VIVO"
            isConnected = true;
            btn.classList.add('live');
            btn.innerHTML = "üõë DETENER TRANSMISI√ìN";
            status.innerText = "üî¥ EN VIVO - Transmitiendo a Base";
            status.style.color = "#ff0000";
            
            call.on('close', stopTransmission);
            call.on('error', stopTransmission);

        } catch (err) {
            console.error(err);
            status.innerText = "Error: No se pudo acceder al micr√≥fono."; colorStatus(false);
            stopTransmission();
        }
    }

    function stopTransmission() {
        if (currentCall) currentCall.close();
        fakeAudio.pause();
        resetUI();
    }

    function resetUI() {
        isConnected = false;
        isScanning = false;
        btn.classList.remove('live');
        btn.innerHTML = "<span>üì∑</span> <span id='btn-text'>ESCANEAR QR MEZCLADOR</span>";
        status.innerText = "Desconectado. Listo para enlazar.";
        status.style.color = "#666";
        qrContainer.style.display = "none";
    }
    function colorStatus(good) { status.style.color = good ? var(--accent) : "#666"; }
</script>
</body>
</html>
