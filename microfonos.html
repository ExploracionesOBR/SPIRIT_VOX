<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>üéôÔ∏è MICRO OBR (FIX)</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <style>
        :root { --accent: #00d2ff; --danger: #ff0000; }
        body { 
            background-image: url('./fondo_pantalla.jpg');
            background-position: center; background-size: cover; background-repeat: no-repeat; background-color: #000;
            color: #ffffff; font-family: system-ui, -apple-system, sans-serif;
            display: flex; flex-direction: column; align-items: center; min-height: 100vh; margin: 0; padding: 20px; box-sizing: border-box;
        }
        body::before { content: ""; position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: -1; }

        .logo-header { margin-bottom: 20px; text-align: center; }
        .obr-logo { width: 80px; height: auto; margin-bottom: 10px; filter: drop-shadow(0 0 10px var(--accent)); display: block; margin: 0 auto; }
        h1 { margin: 0; color: var(--accent); font-size: 1.5rem; letter-spacing: 2px; }

        .main-card {
            background: rgba(0,0,0,0.8); border: 1px solid #333; border-radius: 15px;
            padding: 20px; width: 100%; max-width: 400px; text-align: center;
            backdrop-filter: blur(10px); box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        /* √ÅREA DE C√ÅMARA */
        #qr-reader { width: 100%; margin-bottom: 15px; border-radius: 8px; overflow: hidden; display: none; background: #000; }
        
        /* BOT√ìN PRINCIPAL */
        #btn-action {
            width: 100%; padding: 15px; font-size: 1.1rem; font-weight: bold;
            border: none; border-radius: 10px; cursor: pointer; transition: all 0.3s;
            background: var(--accent); color: #000; box-shadow: 0 0 15px rgba(0, 210, 255, 0.3);
            display: flex; align-items: center; justify-content: center; gap: 10px;
        }
        #btn-action.live { background: var(--danger); color: white; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(255, 0, 0, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(255, 0, 0, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 0, 0, 0); } }

        /* INPUT MANUAL (PLAN B) */
        #manual-input-area { display: none; margin-top: 15px; border-top: 1px solid #333; padding-top: 15px; }
        .input-id { width: 70%; padding: 10px; background: #222; border: 1px solid #555; color: white; border-radius: 5px; text-align: center; text-transform: uppercase; }
        .btn-go { width: 25%; padding: 10px; background: #333; border: 1px solid #fff; color: white; border-radius: 5px; cursor: pointer; }

        #status { margin-top: 15px; font-size: 0.9rem; color: #aaa; font-family: monospace; word-break: break-word; }
        audio { display: none; }
    </style>
</head>
<body>

    <div class="logo-header">
        <img src="./obr-logo.png" alt="OBR Logo" class="obr-logo" onerror="this.style.display='none'">
        <h1>MICROFONO OBR</h1>
    </div>

    <div class="main-card">
        <div id="qr-reader"></div>

        <button id="btn-action">
            <span>üì∑</span> <span id="btn-text">ESCANEAR QR</span>
        </button>

        <div id="manual-input-area">
            <p style="color:#ff4444; font-size:0.8rem; margin-bottom:5px;">‚ö†Ô∏è C√ÅMARA BLOQUEADA - INGRESO MANUAL</p>
            <input type="text" id="input-id" class="input-id" placeholder="ID DEL MEZCLADOR">
            <button class="btn-go" onclick="manualConnect()">IR</button>
        </div>
        
        <div id="status">Esperando acci√≥n...</div>
    </div>

    <audio id="fake-audio" loop playsinline src="data:audio/mp3;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4LjIwLjEwMAAAAAAAAAAAAAAA//oeGQAAAAExBTUUzLjEwMKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq"></audio>

<script>
    const btn = document.getElementById('btn-action');
    const btnText = document.getElementById('btn-text');
    const status = document.getElementById('status');
    const qrContainer = document.getElementById('qr-reader');
    const fakeAudio = document.getElementById('fake-audio');
    const manualArea = document.getElementById('manual-input-area');
    
    let peer = null;
    let currentCall = null;
    let html5QrCode = null;
    let isScanning = false;
    let isConnected = false;

    // 1. INICIALIZAR PEER
    const myMicId = "obr-mic-" + Math.floor(Math.random() * 9999);
    peer = new Peer(myMicId);
    
    peer.on('open', id => { console.log("Mi ID:", id); });
    peer.on('error', err => { status.innerText = "Error Peer: " + err.type; });

    // 2. BOT√ìN PRINCIPAL
    btn.addEventListener('click', () => {
        if(isConnected) { stopTransmission(); return; }
        if (!isScanning) { startQRScanner(); } else { stopQRScanner(); }
    });

    // 3. L√ìGICA DE ESC√ÅNER ROBUSTA
    function startQRScanner() {
        // Verificar soporte de c√°mara primero
        if(!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            alert("Tu navegador no soporta acceso a c√°mara o no es seguro (HTTPS).");
            showManualInput();
            return;
        }

        isScanning = true;
        qrContainer.style.display = "block";
        btnText.innerText = "CANCELAR";
        status.innerText = "Iniciando c√°mara...";

        html5QrCode = new Html5Qrcode("qr-reader");
        
        // Intentar c√°mara trasera
        const config = { fps: 10, qrbox: { width: 250, height: 250 }, aspectRatio: 1.0 };
        
        html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess, onScanFailure)
        .catch(err => {
            // SI FALLA LA C√ÅMARA:
            console.error("Error c√°mara:", err);
            status.innerText = "‚õî No se pudo abrir la c√°mara.";
            stopQRScanner();
            showManualInput(); // Mostrar opci√≥n manual
            alert("Error: No se puede acceder a la c√°mara. Posibles causas:\n1. No est√°s en HTTPS.\n2. Permiso denegado.\n\nUsa el ingreso manual abajo.");
        });
    }

    function stopQRScanner() {
        isScanning = false;
        if(html5QrCode) {
            html5QrCode.stop().then(() => {
                qrContainer.style.display = "none";
                html5QrCode.clear();
            }).catch(e=>{ qrContainer.style.display = "none"; });
        }
        if(!isConnected) {
            btnText.innerText = "ESCANEAR QR";
            status.innerText = "Listo.";
        }
    }

    function showManualInput() {
        manualArea.style.display = "block";
    }

    function onScanSuccess(decodedText) {
        stopQRScanner();
        connectToMixer(decodedText);
    }

    function onScanFailure(error) {
        // No hacer nada, es ruido normal mientras busca
    }

    // 4. CONEXI√ìN MANUAL (Plan B)
    function manualConnect() {
        const id = document.getElementById('input-id').value.trim();
        if(id.length > 0) connectToMixer(id);
        else alert("Escribe el ID del mezclador");
    }

    // 5. TRANSMISI√ìN DE AUDIO
    async function connectToMixer(mixerId) {
        status.innerText = "Conectando a: " + mixerId;
        
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ 
                audio: { echoCancellation: true, noiseSuppression: true, autoGainControl: true }, 
                video: false 
            });

            // Hacks para mantener vivo
            fakeAudio.play().catch(e => {});
            if ('wakeLock' in navigator) navigator.wakeLock.request('screen').catch(e=>{});

            const call = peer.call(mixerId, stream);
            currentCall = call;

            // UI LIVE
            isConnected = true;
            btn.classList.add('live');
            btn.innerHTML = "üõë DETENER (EN VIVO)";
            status.innerText = "TRANSMITIENDO A BASE";
            status.style.color = "#00ff00";
            manualArea.style.display = "none"; // Ocultar manual si conecta

            call.on('close', stopTransmission);
            call.on('error', stopTransmission);

        } catch (err) {
            console.error(err);
            status.innerText = "Error Micr√≥fono: " + err.message;
            alert("No se pudo acceder al micr√≥fono. Revisa permisos.");
            stopTransmission();
        }
    }

    function stopTransmission() {
        if (currentCall) currentCall.close();
        fakeAudio.pause();
        
        isConnected = false;
        isScanning = false;
        btn.classList.remove('live');
        btn.innerHTML = "<span>üì∑</span> <span id='btn-text'>ESCANEAR QR</span>";
        status.innerText = "Desconectado";
        status.style.color = "#aaa";
    }
</script>
</body>
</html>
